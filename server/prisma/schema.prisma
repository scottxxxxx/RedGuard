generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model TestSuite {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  conversations TestConversation[]
  executions    TestExecution[]

  @@map("test_suites")
}

model TestConversation {
  id              String   @id @default(uuid())
  suiteId         String   @map("suite_id")
  conversationId  String   @unique @map("conversation_id")
  name            String?
  targetGuardrail String   @map("target_guardrail")
  expectedOutcome String   @map("expected_outcome") // Enum: pass, fail, block
  createdAt       DateTime @default(now()) @map("created_at")

  suite      TestSuite        @relation(fields: [suiteId], references: [id])
  utterances Utterance[]
  results    TestResult[]

  @@map("test_conversations")
}

model Utterance {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  turnNumber     Int      @map("turn_number")
  role           String   // Enum: user, assistant
  content        String
  metadata       String?  // JSONB stored as string for SQLite compatibility

  conversation TestConversation @relation(fields: [conversationId], references: [id])

  @@map("utterances")
}

model TestExecution {
  id          String    @id @default(uuid())
  suiteId     String?   @map("suite_id")
  status      String    // Enum: pending, running, completed, failed
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  totalTests  Int?      @default(0) @map("total_tests")
  passed      Int?      @default(0)
  failed      Int?      @default(0)
  errors      Int?      @default(0)

  suite   TestSuite?   @relation(fields: [suiteId], references: [id])
  results TestResult[]

  @@map("test_executions")
}

model TestResult {
  id                          String   @id @default(uuid())
  executionId                 String   @map("execution_id")
  conversationId              String   @map("conversation_id")
  guardrailType               String   @map("guardrail_type")
  guardrailStage              String?  @map("guardrail_stage") // Enum: input, output
  expectedBlocked             Boolean? @map("expected_blocked")
  wasBlocked                  Boolean? @map("was_blocked")
  responseContent             String?  @map("response_content")
  violationDetected           Boolean? @map("violation_detected")
  violationReason             String?  @map("violation_reason")
  aiAnalysis                  String?  @map("ai_analysis")
  promptImprovementSuggestion String?  @map("prompt_improvement_suggestion")
  latencyMs                   Int?     @map("latency_ms")
  createdAt                   DateTime @default(now()) @map("created_at")

  execution         TestExecution       @relation(fields: [executionId], references: [id])
  conversation      TestConversation    @relation(fields: [conversationId], references: [id])
  promptImprovements PromptImprovement[]

  @@map("test_results")
}

model EvaluationPrompt {
  id            String   @id @default(uuid())
  guardrailType String   @map("guardrail_type")
  promptText    String   @map("prompt_text")
  version       Int      @default(1)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  improvements PromptImprovement[]

  @@map("evaluation_prompts")
}

model PromptImprovement {
  id                String   @id @default(uuid())
  originalPromptId  String?  @map("original_prompt_id")
  improvedPrompt    String   @map("improved_prompt")
  improvementReason String?  @map("improvement_reason")
  testResultId      String?  @map("test_result_id")
  effectivenessScore Decimal? @map("effectiveness_score")
  createdAt         DateTime @default(now()) @map("created_at")

  originalPrompt EvaluationPrompt? @relation(fields: [originalPromptId], references: [id])
  testResult     TestResult?       @relation(fields: [testResultId], references: [id])

  @@map("prompt_improvements")
}

model EvaluationRun {
  id             String   @id @default(uuid())
  userInput      String   @map("user_input")
  botResponse    String   @map("bot_response")
  promptSent     String   @map("prompt_sent")
  llmOutput      String   @map("llm_output")
  
  // Pass/Fail for each guardrail category
  toxicityPass   Boolean? @map("toxicity_pass")
  topicsPass     Boolean? @map("topics_pass")
  injectionPass  Boolean? @map("injection_pass")
  regexPass      Boolean? @map("regex_pass")
  
  overallPass    Boolean  @map("overall_pass")
  isAttack       Boolean  @default(false) @map("is_attack")
  totalTokens    Int?     @map("total_tokens")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("evaluation_runs")
}

model ApiLog {
  id             String   @id @default(uuid())
  timestamp      DateTime @default(now())
  
  // Request classification
  logType        String   @map("log_type")     // 'kore_chat', 'llm_evaluate', 'garak'
  direction      String   @default("outbound") // 'outbound' (to API) or 'inbound' (response)
  
  // Request details
  method         String?                       // HTTP method
  endpoint       String?                       // URL or endpoint called
  requestBody    String?  @map("request_body") // JSON stringified request
  requestHeaders String?  @map("request_headers") // JSON stringified headers (sanitized)
  
  // Response details
  statusCode     Int?     @map("status_code")
  responseBody   String?  @map("response_body") // JSON stringified response
  
  // Performance
  latencyMs      Int?     @map("latency_ms")
  totalTokens    Int?     @map("total_tokens")
  
  // Error tracking
  isError        Boolean  @default(false) @map("is_error")
  errorMessage   String?  @map("error_message")
  
  // Context
  sessionId      String?  @map("session_id")   // To group related requests
  provider       String?                       // 'anthropic', 'openai', 'gemini', 'kore'
  model          String?                       // Model used (if LLM)

  @@map("api_logs")
}

model KoreLLMLog {
  id             String   @id @default(uuid())
  koreId         String?  @unique @map("kore_id") // Original ID from Kore if available
  timestamp      DateTime @default(now())
  
  sessionId      String?  @map("session_id")
  featureName    String?  @map("feature_name")
  model          String?
  status         String?
  description    String?
  
  // Payload
  requestPayload  String? @map("request_payload")
  responsePayload String? @map("response_payload")
  
  // Token usage
  inputTokens    Int?     @default(0) @map("input_tokens")
  outputTokens   Int?     @default(0) @map("output_tokens")
  totalTokens    Int?     @default(0) @map("total_tokens")
  
  // Metadata
  botId          String?  @map("bot_id")
  userId         String?  @map("user_id") // RedGuard user ID
  channelUserId  String?  @map("channel_user_id") // Kore channel user ID

  createdAt      DateTime @default(now()) @map("created_at")

  @@map("kore_llm_logs")
}
